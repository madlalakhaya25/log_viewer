<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/css/style.css">

    <title>Log Viewer</title>

    <script>

function toggleLogDetails(logId) {
            var logDetails = document.getElementById('details-' + logId);
            var arrow = document.getElementById('arrow-' + logId);

            // Toggle visibility of log details and rotate the arrow icon
            logDetails.style.display = (logDetails.style.display === 'none' || logDetails.style.display === '') ? 'block' : 'none';
            arrow.classList.toggle('rotate');

            // If log details are visible, format them based on content
            if (logDetails.style.display === 'block') {
                var logEntry = document.getElementById('entry-' + logId).textContent;

                try {
                    
                    // Attempt to parse the log entry as JSON
                    var jsonLog = JSON.parse(logEntry);
                    logDetails.innerHTML = '<pre>' + JSON.stringify(jsonLog, null, 2) + '</pre>';

                } catch (error) {
                    // If parsing as JSON fails, assume it's a regular log entry
                    logDetails.innerHTML = '<pre>' + logEntry + '</pre>';
                }
            }
        }



        function rotateArrow(logId) {
            var arrow = document.getElementById('arrow-' + logId);
            arrow.classList.toggle('rotate');
        }

        // Function to scroll to the first highlighted keyword on page load
        function scrollToHighlighted() {
            var highlightedElements = document.querySelectorAll('.highlight');
            if (highlightedElements.length > 0) {
                highlightedElements[0].scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Function to highlight search results in log entries
        function highlightSearchResults(keyword) {
            var logEntries = document.querySelectorAll('.log-entries pre');
            logEntries.forEach(function (entry) {
                var entryHTML = entry.innerHTML;
                var regex = new RegExp('(' + keyword + ')', 'gi');
                entry.innerHTML = entryHTML.replace(regex, '<span class="highlight">$1</span>');
            });
        }

        // Function to move to the next occurrence of the highlighted keyword
        function searchNext() {
            var currentHighlight = document.querySelector('.highlight');
            if (currentHighlight) {
                currentHighlight.classList.remove('highlight');
                var nextHighlight = currentHighlight.nextElementSibling;
                if (nextHighlight) {
                    nextHighlight.classList.add('highlight');
                    nextHighlight.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }

        // Function to move to the previous occurrence of the highlighted keyword
        function searchPrevious() {
            var currentHighlight = document.querySelector('.highlight');
            if (currentHighlight) {
                currentHighlight.classList.remove('highlight');
                var previousHighlight = currentHighlight.previousElementSibling;
                if (previousHighlight) {
                    previousHighlight.classList.add('highlight');
                    previousHighlight.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }
    </script>
</head>
<body onload="scrollToHighlighted()">
    <div class="container">
        <h1>Log Viewer</h1>
    <!-- Search form with buttons for navigation -->
    <form action="/" method="get">
        <label for="search">Search:</label>
        <input type="text" id="search" name="search" value="{{ search_keyword }}">
        <input type="submit" value="Search">
        <button type="button" onclick="searchNext()">Next</button>
        <button type="button" onclick="searchPrevious()">Previous</button>
    </form>

    <div class="log-entries">
        <pre>
            {% for entry in log_entries %}
                <!-- Inside the <div class="log-entries"> ... </div> block in log_viewer.html -->
                <div onclick="toggleLogDetails('{{ loop.index0 }}');" style="cursor: pointer;">
                    <span id="arrow-{{ loop.index0 }}" class="arrow-down"></span> {{ entry | safe }}<br>
                    <div class="log-details" id="details-{{ loop.index0 }}">
                        {% if 'deployed_bots' in entry %}
                            <!-- Decode HTML entities and display JSON data -->
                            {% set decoded_entry = entry | replace('&lt;', '<') | replace('&gt;', '>') | replace('&quot;', '"') | replace('&#39;', "'") %}
                            <pre>{{ decoded_entry | safe }}</pre>
                        {% else %}
                            {{ entry | safe }}
                        {% endif %}
                    </div>
                </div>
                
            {% endfor %}
        </pre>
    </div>
</div>
</body>
</html>